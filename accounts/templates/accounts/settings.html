{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Settings</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
  <style>
    .navbar-custom {
      background-color: #007bff;
    }
    .navbar-custom .navbar-brand,
    .navbar-custom .nav-link,
    .navbar-custom .fa {
      color: #fff;
    }
    .navbar-custom .nav-link:hover,
    .navbar-custom .fa:hover {
      color: #e2e2e2;
    }

    .tree ul {
  list-style-type: none;
  padding-left: 20px;
  position: relative;
}

.tree ul::before {
  content: '';
  position: absolute;
  top: 0;
  left: 8px;
  width: 1px;
  height: 100%;
  background: #ccc;
}

.tree li {
  position: relative;
  padding: 5px 0 5px 20px;
  line-height: 1.5;
  transition: background 0.3s;
}

.tree li::before {
  content: '\f0da'; /* FontAwesome angle-right */
  font-family: "Font Awesome 6 Free";
  font-weight: 900;
  position: absolute;
  left: 0;
  top: 6px;
  color: #007bff;
  font-size: 12px;
  transition: transform 0.3s;
}

.tree li.open::before {
  transform: rotate(90deg);
}

.tree li:hover {
  background: #f1f1f1;
  border-radius: 4px;
  cursor: pointer;
}

.tree li > ul {
  margin-top: 5px;
}

    .container-flex {
      display: flex;
      margin-top: 20px;
    }

    .left-panel {
      width: 30%;
      border-right: 1px solid #ccc;
      padding-right: 15px;
      max-height: 80vh;
      overflow-y: auto;
    }

    .right-panel {
      width: 70%;
      padding-left: 15px;
    }

     .dropdown-toggle::after {
      display: none;
    }

    .dropdown-menu {
      right: 0;
      left: auto;
    }

    .editable-field {
      border: none;
      background: transparent;
      width: 100%;
      resize: vertical;
    }

    .edit-mode .editable-field {
      border: 1px solid #ced4da;
      background: white;
      padding: 5px;
    }

    .result-area {
      position: relative;
    }

    .edit-buttons {
      position: absolute;
      top: 10px;
      right: 10px;
    }
  </style>
</head>
<body>

<!-- Navbar -->
<nav class="navbar navbar-custom px-3">
  <span class="navbar-brand mb-0 h1">Menu</span>

  <a href="{% url 'home' %}" class="btn btn-outline-light ms-auto me-3">
    <i class="fas fa-file-alt me-1"></i> Document Classifier
  </a>
  
  <div class="dropdown">
    <a href="#" class="d-flex align-items-center text-white text-decoration-none dropdown-toggle" id="userDropdown" data-bs-toggle="dropdown" aria-expanded="false">
      <i class="fas fa-user-circle fa-2x"></i>
    </a>
   
   <!-- Dashboard Button -->
  
    <ul class="dropdown-menu dropdown-menu-end text-center" aria-labelledby="userDropdown">
      <li><a class="dropdown-item" href="{% url 'logout' %}">Logout</a></li>
    </ul>
  </div>
</nav>


<div class="container-flex px-4">
  <!-- Left tree panel -->
  <div class="left-panel tree" id="treeContainer">
    Loading tree...
  </div>
  <div class="right-panel">
    <div class="result-area border rounded p-3" style="min-height: 200px;" id="resultArea">
      <!-- Results will appear here -->
      <h5>Select a document to view its details.</h5>
    </div>
  </div>
</div>

<div class="container mt-5">
  <h2>Users</h2>
  <table class="table table-bordered mt-3">
    <thead class="table-light">
      <tr>
        <th>#</th>
        <th>Email</th>
        <th>First Name</th>
        <th>Last Name</th>
        <th>Password</th>
        <th>Action</th>
      </tr>
    </thead>
    <tbody id="userTableBody">
      {% for user in users %}
      <tr data-id="{{ user.0 }}">
        <td>{{ forloop.counter }}</td>
        <td class="email">{{ user.1 }}</td>
        <td class="first-name">{{ user.2 }}</td>
        <td class="last-name">{{ user.3 }}</td>
        <td class="password"> {{ user.4 }}</td>
        <td>
          <button class="btn btn-sm btn-primary edit-btn">Edit</button>
        </td>
      </tr>
      {% endfor %}

      <!-- New user row -->
      <tr>
  <td>New</td>
  <td>
    <input type="email" class="form-control" id="newEmail" placeholder="Email"
           pattern="^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9-]+-[a-zA-Z0-9-]+\.com$"
           title="Email must follow the pattern name@abc-def.com">
  </td>
  <td><input type="text" class="form-control" id="newFirstName" placeholder="First Name"></td>
  <td><input type="text" class="form-control" id="newLastName" placeholder="Last Name"></td>
  <td><input type="password" class="form-control" id="newPassword" placeholder="Password"></td>
  <td>
    <button class="btn btn-sm btn-success" onclick="addUser()">Add User</button>
  </td>
</tr>

    </tbody>
  </table>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
// Global variables to track current selection
let currentCategory = '';
let currentSubcategory = '';
let isEditMode = false;

$(document).on('click', '.edit-btn', function () {
  const $row = $(this).closest('tr');
  const id = $row.data('id');
  const isEditing = $(this).text() === 'Edit';

  if (isEditing) {
    const email = $row.find('.email').text();
    const first = $row.find('.first-name').text();
    const last = $row.find('.last-name').text();
    const password = $row.find('.password').text().trim();

    $row.find('.email').html(`<input class="form-control" value="${email}">`);
    $row.find('.first-name').html(`<input class="form-control" value="${first}">`);
    $row.find('.last-name').html(`<input class="form-control" value="${last}">`);
    $row.find('.password').html(`<input type="password" class="form-control" value="${password}">`);
    

    $(this).replaceWith(`
      <button class="btn btn-sm btn-success save-btn">Save</button>
      <button class="btn btn-sm btn-secondary cancel-btn">Cancel</button>
    `);
  }
});

$(document).on('click', '.cancel-btn', function () {
  const $row = $(this).closest('tr');
  const id = $row.data('id');

  // Fetch original data from row attributes
  const email = $row.find('.email input').attr('value');
  const first = $row.find('.first-name input').attr('value');
  const last = $row.find('.last-name input').attr('value');
    const password = $row.find('.password input').attr('value');

  $row.find('.email').text(email);
  $row.find('.first-name').text(first);
  $row.find('.last-name').text(last);
  $row.find('.password').text(password);
  $row.find('.save-btn, .cancel-btn').remove();
  $row.find('td:last').append(`<button class="btn btn-sm btn-primary edit-btn">Edit</button>`);
});

$(document).on('click', '.save-btn', function () {
  const $row = $(this).closest('tr');
  const id = $row.data('id');
  const email = $row.find('.email input').val();
  const firstName = $row.find('.first-name input').val();
  const lastName = $row.find('.last-name input').val();
  const password = $row.find('.password input').val();

  $.post("{% url 'update_user' %}", {
    user_id: id,
    email: email,
    first_name: firstName,
    last_name: lastName,
    password: password,
    csrfmiddlewaretoken: '{{ csrf_token }}'
  }, function (data) {
    if (data.status === 'success') {
      $row.find('.email').text(email);
      $row.find('.first-name').text(firstName);
      $row.find('.last-name').text(lastName);
      $row.find('.password').text(password);
      $row.find('.save-btn, .cancel-btn').remove();
      $row.find('td:last').append(`<button class="btn btn-sm btn-primary edit-btn">Edit</button>`);
    } else {
      alert('Update failed');
    }
  });
});

function addUser() {
  const email = $('#newEmail').val();
  const first = $('#newFirstName').val();
  const last = $('#newLastName').val();
  const password = $('#newPassword').val();

  if (!email || !first || !last || !password) {
    alert("All fields are required");
    return;
  }

  $.post("{% url 'add_user' %}", {
    email: email,
    first_name: first,
    last_name: last,
    password: password,
    csrfmiddlewaretoken: '{{ csrf_token }}'
  }, function (data) {
    if (data.status === 'success') {
      location.reload();
    } else {
      alert('Failed to add user');
    }
  });
}

// Load JSON and build tree
  // fetch("{% static 'accounts/data.json' %}") // <-- change path if needed
  fetch("{% url 'get_category_data' %}")
    .then(res => res.json())
    .then(data => buildTree(data))
    .catch(err => document.getElementById('treeContainer').innerText = 'Failed to load tree');

  function buildTree(data) {
    const treeContainer = document.getElementById('treeContainer');
    const ul = document.createElement('ul');

    data.forEach(category => {
      const li = document.createElement('li');
      li.textContent = category.CategoryName;
      // li.addEventListener('click', function (e) {
      //   e.stopPropagation();
      //   const subUl = this.querySelector('ul');
      //   if (subUl) subUl.style.display = subUl.style.display === 'none' ? 'block' : 'none';
      // });
      li.addEventListener('click', function (e) {
  e.stopPropagation();
  const subUl = this.querySelector('ul');
  if (subUl) {
    const isOpen = subUl.style.display === 'block';
    subUl.style.display = isOpen ? 'none' : 'block';
    this.classList.toggle('open', !isOpen); // Toggle arrow direction
  }
});

      const subUl = document.createElement('ul');
      subUl.style.display = 'none';

      category.SubCategory.forEach(sub => {
        const subLi = document.createElement('li');
        subLi.textContent = sub.SubCategoryName;
        subLi.addEventListener('click', function (e) {
          e.stopPropagation();
          showDescription(category.CategoryName, sub.SubCategoryName, sub.Description);
        });
        subUl.appendChild(subLi);
      });

      li.appendChild(subUl);
      ul.appendChild(li);
    });

    treeContainer.innerHTML = '';
    treeContainer.appendChild(ul);
  }

  function showDescription(category, subcategory, description) {
    currentCategory = category;
    currentSubcategory = subcategory;
    isEditMode = false;
    
    const area = document.getElementById('resultArea');
    area.innerHTML = `
      <div class="edit-buttons">
        <button class="btn btn-sm btn-primary" id="editCategoryBtn">Edit</button>
      </div>
      <div id="contentArea">
        <h5><strong>Category:</strong> <span id="categoryName">${category}</span></h5>
        <h6><strong>Subcategory:</strong> <span id="subcategoryName">${subcategory}</span></h6>
        <p><strong>Description:</strong><br><span id="descriptionText">${description}</span></p>
      </div>
    `;
    
    // Add edit button functionality
    document.getElementById('editCategoryBtn').addEventListener('click', toggleEditMode);
  }

  function toggleEditMode() {
    const area = document.getElementById('resultArea');
    const editBtn = document.getElementById('editCategoryBtn');
    const contentArea = document.getElementById('contentArea');
    
    if (!isEditMode) {
      // Switch to edit mode
      isEditMode = true;
      editBtn.textContent = 'Cancel';
      editBtn.className = 'btn btn-sm btn-secondary';
      
      const categoryName = document.getElementById('categoryName').textContent;
      const subcategoryName = document.getElementById('subcategoryName').textContent;
      const descriptionText = document.getElementById('descriptionText').textContent;
      
      contentArea.innerHTML = `
        <div class="edit-mode">
          <div class="mb-3">
            <label class="form-label"><strong>Category:</strong></label>
            <input type="text" class="form-control editable-field" id="editCategoryName" value="${categoryName}">
          </div>
          <div class="mb-3">
            <label class="form-label"><strong>Subcategory:</strong></label>
            <input type="text" class="form-control editable-field" id="editSubcategoryName" value="${subcategoryName}">
          </div>
          <div class="mb-3">
            <label class="form-label"><strong>Description:</strong></label>
            <textarea class="form-control editable-field" id="editDescription" rows="4">${descriptionText}</textarea>
          </div>
          <div class="d-flex gap-2">
            <button class="btn btn-success" id="saveChanges">Save Changes</button>
            <button class="btn btn-secondary" id="cancelEdit">Cancel</button>
          </div>
        </div>
      `;
      
      // Add save functionality
      document.getElementById('saveChanges').addEventListener('click', saveChanges);
      document.getElementById('cancelEdit').addEventListener('click', function() {
        showDescription(currentCategory, currentSubcategory, document.getElementById('editDescription').value);
      });
      
    } else {
      // Cancel edit mode
      showDescription(currentCategory, currentSubcategory, document.getElementById('descriptionText').textContent);
    }
  }

  function saveChanges() {
    const newCategoryName = document.getElementById('editCategoryName').value.trim();
    const newSubcategoryName = document.getElementById('editSubcategoryName').value.trim();
    const newDescription = document.getElementById('editDescription').value.trim();
    
    if (!newCategoryName || !newSubcategoryName || !newDescription) {
      alert('All fields are required');
      return;
    }
    
    // Save category if changed
    if (newCategoryName !== currentCategory) {
      $.post("{% url 'update_category' %}", {
        category_name: currentCategory,
        new_category_name: newCategoryName,
        csrfmiddlewaretoken: '{{ csrf_token }}'
      }, function(data) {
        if (data.status === 'success') {
          currentCategory = newCategoryName;
          updateSubcategory();
        } else {
          alert('Failed to update category: ' + data.message);
        }
      }).fail(function() {
        alert('Error updating category');
      });
    } else {
      updateSubcategory();
    }
    
    function updateSubcategory() {
      // Save subcategory and description
      $.post("{% url 'update_subcategory' %}", {
        category_name: currentCategory,
        subcategory_name: currentSubcategory,
        new_subcategory_name: newSubcategoryName,
        new_description: newDescription,
        csrfmiddlewaretoken: '{{ csrf_token }}'
      }, function(data) {
        if (data.status === 'success') {
          currentSubcategory = newSubcategoryName;
          // Refresh the tree and show updated content
          fetch("{% static 'accounts/data.json' %}?t=" + new Date().getTime())
            .then(res => res.json())
            .then(data => {
              buildTree(data);
              showDescription(currentCategory, currentSubcategory, newDescription);
              alert('Changes saved successfully!');
            });
        } else {
          alert('Failed to update subcategory: ' + data.message);
        }
      }).fail(function() {
        alert('Error updating subcategory');
      });
    }
  }

</script>

</body>
</html>